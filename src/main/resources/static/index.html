<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>KxReport</title>
        <link rel="icon" type="image/x-icon" href="./favicon.ico" />
        <style>
            body {
                background-color: black;
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
            }
            .center {
                display: flex;
                flex-direction: column;
                gap: 10px;
                padding: 20px;
                background-color: lightgrey;
                border: 1px solid black;
            }
            #form {
                border: 1px solid grey;
                padding: 10px;
            }
            table {
                border-collapse: collapse;
            }
            td {
                padding: 5px;
            }
        </style>
    </head>

    <body>
        <div class="center">
            <form id="form" action="getPDF" method="get" target="report">
                <fieldset style="border: none; padding: 0; margin: 0">
                    <div
                        style="
                            display: grid;
                            grid-template-columns: max-content 1fr; /* Label width + Input fills rest */
                            gap: 8px 15px; /* Vertical and horizontal spacing */
                        "
                    >
                        <label for="report">Report</label>
                        <input type="text" name="report" id="report" value="A00" required />
                        <label for="db">Database</label>
                        <input type="text" name="db" id="db" value="kxtest" required />
                        <label for="comCode">Company Code</label>
                        <input type="number" name="comCode" id="comCode" value="1" />
                        <label for="comName">Company Name</label>
                        <input type="text" name="comName" id="comName" value="Company Name" />
                        <label for="fromDate">From Date</label>
                        <input type="date" name="fromDate" id="fromDate" />
                        <label for="toDate">To Date</label>
                        <input type="date" name="toDate" id="toDate" />
                        <label for="fromId">From ID</label>
                        <input type="text" name="fromId" id="fromId" value="000000" />
                        <label for="toId">To ID</label>
                        <input type="text" name="toId" id="toId" value="999999" />
                        <label for="option">Option</label>
                        <input type="number" name="option" id="option" value="1" />
                        <label for="idList">ID List</label>
                        <input type="text" name="idList" id="idList" value="" />
                        <label for="saveFile">Save File</label>
                        <input type="text" name="saveFile" id="saveFile" value="" />
                    </div>
                </fieldset>
                <hr />
                <button type="submit">Submit Form Report (getPDF)</button>
                <p>
                    Click here to view the
                    <a href="list.html">Report List</a>
                </p>
            </form>

            <button onclick="callService('filePDF')">Call FilePDF (FileName)</button>
            <button onclick="callService('fileCSV')">Export CSV (Download)</button>
            <button onclick="callService('openPDF')">Call OpenPDF (Blob)</button>
        </div>
    </body>

    <script>
        function initDates() {
            const today = new Date().toISOString().substring(0, 10)
            const yearStart = today.substring(0, 4) + "-01-01"
            document.getElementsByName("toDate")[0].value = today
            document.getElementsByName("fromDate")[0].value = yearStart
        }
        initDates()
        function openWin(url = "report.html") {
            return window.open(
                url,
                "report",
                "width=800,height=800,toolbar=no,menubar=no,location=no",
            )
        }
        function getFormDataAsJson() {
            const form = document.getElementById("form")
            const data = Object.fromEntries(new FormData(form).entries())
            // data.app = "" // default app name
            return data
        }
        async function callService(service) {
            let reportWindow = openWin()
            try {
                const data = getFormDataAsJson()
                const response = await fetch(service, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data),
                })
                if (!response.ok)
                    throw new Error(`Service call failed with status: ${response.status}`)

                if (service === "filePDF")
                    reportWindow.location.href = "." + (await response.text())
                else if (service === "fileCSV")
                    reportWindow.location.href = "." + (await response.text())
                else if (service === "openPDF")
                    reportWindow.location.href = URL.createObjectURL(await response.blob())
            } catch (error) {
                console.error(`Error calling ${service}:`, error)
                alert(`KEEHIN Report Error: ${error.message}`)
            }
        }
    </script>
</html>
